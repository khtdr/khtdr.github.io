
<!DOCTYPE html>
<html>
    <head>
        <title>KHTDR - Simple Live-Reload Node.js Server</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1">
        <meta name="description" content="Tutorial on building a 'live-reload' server for HTML, CSS, and Javascript. Uses express, socket.io, node, and the watch feature from node's FS library. Easy.">
        <link rel="canonical" href="https://khtdr.com/tutorials/simple-live-reload-server.html" />
        <link rel="stylesheet" href="/styles.css">
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/styles/agate.min.css">
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
        <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/highlight.min.js"></script>
        <script> hljs.initHighlightingOnLoad(); </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
        <script>
            $(function () {
                $('pre > code').each(function (index) {
                    var $div = $('<div />')
                    var $button = $('<button>copy</button>')
                    var id = 'pbc-' + index
                    $(this).attr('id', id)
                    $div.css({
                        position: 'relative'
                    })
                    $button.addClass('code-copy')
                    $button.css({
                        position: 'absolute',
                        right: '0',
                        top: '-63px'
                    })
                    $div.append($button).insertAfter($(this).parent())
                    $button.attr('data-clipboard-target', '#' + id)
                })
                var clipboard = new ClipboardJS('pre + div > button:first-child')
                clipboard.on('success', function(e) {
                    setTimeout(function () {
                        e.clearSelection();
                    }, 33)
                });
            })
        </script>
        <style>
            h1 + div {
                display:flex;
                justify-content: center;
                align-items: center;
            }
            h1 + div > p {
                margin-block-start: 0;
                margin-block-end: 0;
            }
            h1 + div > :first-child {
                white-space: nowrap;
            }
            h1 + div > :nth-child(2) {
                padding: 20px;
                font-size: 32px;
            }
            h1 + div img {
                display: block;
                width: 100%;
                max-width: 350px;
                height: auto; 
                border: solid 1px white;
            }
            h1 + div img + small {
                display: block;
                color: white;
                text-align: center;
            }
            @media (max-width: 533px) {
                h1 + div {
                    flex-direction: column;
                }
            }
        </style>
    </head>
    <body><div>
        <header>
            <h1><span>KHTDR - escalator <small>temporarily <small>stairs</small></small></span></h1>
            <nav>
                <ul>
                    <li class=item>
                        <a href="/">Homepage</a>
                    </li>
                    <li><strong>Tutorials</strong></li>
                    <ul>
                        <li class=item>
                            <a href="/tutorials/simple-live-reload-server.html">
                                A simple "live-reload" Node.js server.</a>
                        </li>
                    </ul>
                    <li><strong>Projects</strong></li>
                    <ul>
                        <li class=item>
                            <a href="/opts.html">opts.js Command line options parser</a>
                        </li>
                        <li class=item>
                            <a href="/react-zondicons">React-Zondicons Component Library</a>
                        </li>
                    </ul>
                </ul>
            </nav>
        </header>

        <main>
            <h1>A hot-reloading Express node server.</h1>
            <div>
                <p>
                    <span style="opacity:1">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.9">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.8">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.7">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.6">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.5">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.4">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.3">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.2">Edit, save, ctrl+tab, refresh.</span><br />
                    <span style="opacity:.1">Edit, save, ctrl+tab, refresh.</span><br />
                <p>or
                <p>
                    <a href="/lrs-preview.gif" target=_blank id=preview>
                        <img src="/lrs-preview.gif" />
                        <small>click for full size image</small>
                    </a>
            </div>

                <h2>The Setup</h2>

            <p>
                You are editing HTML, CSS, and Javascript by hand, because you like it.
                You've had some of that hot-reloading goodness before, and you want it now,
                too.

            <p>
                You don't feel like spending the weekend reading Webpack docs, so you decide
                that it should only take a few dozen lines of Javascript, at most, to roll
                your own.

            <p>
                You already have node and npm installed. So you go for it.

                <h2>Planning a solution</h2>

                You want to be able to:
                <ul>
                    <li>serve static files
                    <li>refresh the page whenever a file changes
                </ul>

            <p>
                For serving static files, there are many options to choose. The best choice
                will be the one that allows you to solve the "refresh" problem easiest.

            <p>
                How can you <strong>refresh the page when a file changes</strong>?
                Since you want paths to work as expected, so you can include css, images,
                and javascript, etc., you will run an HTTP server.

            <p>
                You will need to:
                <ol>
                    <li>detect when a file changes
                    <li>send a signal from the server to the web browser
                    <li>trigger a reresh on the page
                </ol>


            <p>Simple enough :)

                <h2>Building the solution</h2>

                <h3>Putting together a web server</h3>
            <p>
                <a href="https://expressjs.com/">Express.js</a> has a built-in solution for
                serving static files. And Node.js already has the http server.

                <pre><code>cd ~/live-reload-app # ya know, or whever you want
npm install express</code></pre>

            <p>This HTTP server listens on port 8080 and serves files found in the same
                directory.

                <pre><code>var express = require('express');
var app = express();
app.use(express.static(__dirname));

var http = require('http').Server(app);
http.listen(8080);</code></pre>

            <p>
                Save the code above to a file named <code>server.js</code> and run it:

                <pre><code>node server.js</code></pre>

            <p>
                You can verify it is working by opening a browser and going to
                <code>https://localhost:8080/server.js</code>. You will see your code that is
                running. Create a minimal webpage with an external stylesheet.

            <p>Create the HTML. Save it to <code>index.html</code>

                <pre><code class='html'>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;link rel='stylesheet' href='/theme.css' /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    Greetings!
  &lt;/body&gt;
&lt;/html&gt;</code></pre>

            <p>and the CSS

                <pre><code>echo "body { background-color:yellow }" &gt; ./theme.css</code></pre>

                Make sure the server is running, and go to
                <code>https://localhost:8080</code>. You will see a yellow page with your
                greeting.

                <h3>Implementing the "live-reload" feature</h3>

                Node.js provides a file-watcher you can use to monitor the directory for
                changes. But the docs also have something to say about using this feature.

                <blockquote>
                    The fs.watch API is not 100% consistent across platforms, and is unavailable in some situations.
                    <br /><br />

                    The recursive option is only supported on OS X and Windows.
                </blockquote>

            <p>
                Lucky(?) for you, this is good enough to get started. You will still need to
                signal to the browser when a change is detected, and for that you can use
                <a href="https://socket.io/">Socket.io</a>.

                <pre><code>npm install socket.io socket.io-client</code></pre>

            <p>
                The code is straight forward. Watch the working directory for changes, and
                emit an event with Socket.io.

                <pre><code>var fs = require('fs');
var io = require('socket.io')(http);
fs.watch(__dirname, { recursive:true }, function () {
  io.emit('file-change-event');
});</code></pre>

            <p>
                The Socket.io server can be started various ways. Here it is given the HTTP
                server from the previous step.

            <p>
                Finally, a puzzle to solve. Something needs to listen for the
                <code>file-change-event</code> emitted by the server. Upon receiving the
                event, the page also needs refreshed. So it makes sense to put the "listening
                code" on the webpage itself.

            <p>
                For obviously obvious reasons, you don't want to add the javascript to
                <em>every page you fiddle with</em>. Better to have the server inject it
                automatically for you!

            <p>
                So what is this "listening code" that needs to be on every HTML page?

                <pre><code>&lt;script src="/node_modules/socket.io-client/dist/socket.io.js"&gt;&lt;/script&gt;
&lt;script&gt;
  var socket = io();
  socket.on("file-change-event", function () {
    window.location.reload();
  });
&lt;/script&gt;</code></pre>

            <p>
                The snippet above includes the client library that we installed with NPM
                earlier. It creates a new Socket.io client, and upon receiving the
                <code>file-change-event</code> from the server, reloads the page.

            <p>
                Now you need to serve that snippet of javascript along with every HTML page.
                Back to Express.

            <p>
                Write a <code>GET</code> handler that intercepts requests for HTML pages and
                appends the "listening code" to the page.

                <pre><code>app.get('/index.html', function (_, res) {
  fs.readFile(__dirname + '/index.html', function (_, data) {
    res.send(data
    + '&lt;script src="/node_modules/socket.io-client/dist/socket.io.js"&gt;&lt;/script&gt;'
    + '&lt;script&gt;'
    + '  var socket = io();'
    + '  socket.on("file-change-event", function () {'
    + '    window.location.reload();'
    + '  });'
    + '&lt;/script&gt;'
    );
  });
});</code></pre>
            <p>
                That solves the problem for the <code>index.html</code> page, but what about
                the rest of the HTML pages? Instead of hard-coding the path, you can use
                a regular expression to intercept requests for HTML pages and directories.
            <p>
                When a request ends in a slash, take care to append <code>index.html</code>
                to the requested path.
            <p>
                Change:
                <pre><code>app.get('/index.html', function (_, res) {
  fs.readFile(__dirname + '/index.html', function (_, data) {
    ...
  });
});</code></pre>

            <p>to:

                <pre><code>app.get([/\/$/, /.*\.html$/], function (req, res) {
  var filename = __dirname + req.path;
  filename += filename.endsWith('/')? 'index.html': '';
  fs.readFile(filename, function (_, data) {
    ...
  });
});</code></pre>

            <p>
                Now, <strong>putting it all together!</strong>

                <pre><code>var express = require('express');
var app = express();
app.get([/\/$/, /.*\.html$/], function (req, res) {
  var filename = __dirname + req.path;
  filename += filename.endsWith('/')? 'index.html': '';
  fs.readFile(filename, function (_, data) {
    res.send(data
    + '&lt;script src="/node_modules/socket.io-client/dist/socket.io.js"&gt;&lt;/script&gt;'
    + '&lt;script&gt;'
    + '  var socket = io();'
    + '  socket.on("file-change-event", function () {'
    + '    window.location.reload();'
    + '  });'
    + '&lt;/script&gt;'
    );
  });
});
app.use(express.static(__dirname));

var http = require('http').Server(app);
http.listen(8080);

var fs = require('fs');
var io = require('socket.io')(http);
fs.watch(__dirname, { recursive:true }, function () {
  io.emit('file-change-event');
});</code></pre>

            <p><strong>That's it!</strong>

            <p>
                Start the server with <code>node server.js</code>, go to
                <code>https://localhost:8080</code> in your browser, and take a good look at
                your yellow page. Open up the css file you created earlier, and change
                <code>yellow</code> to <code>orange</code>. Save, <em>but don't refresh your
                    page</em>. Just observe. The page will automatically update.

            <p>That's it? What next?
                <ul>
                    <li>Make more pages
                    <li>???
                    <li>Profit
                </ul>

            <p>
                I don't know, you tell me :)


            <p> <a href="/">homepage</a>

            <p><small>
                    Email me with your suggestions, corrections, additions,
                    questions, whatever. I will include it here with a link to your work.
                </small>


        </main>
        <footer>
            &copy; 2016 - 2020
            <a href="mailto:ohkay@khtdr.com">ohkay@khtdr.com</a>
            <a href="https://khtdr.com">khtdr.com</a>
        </footer>
</div>    </body>
</html>

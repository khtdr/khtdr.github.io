<!DOCTYPE html>
<html>
<head>
<title>KHTDR - Simple Live-Reload Node.js Server</title>
<style>
html { margin:0; padding:0 }
body {
  margin:0; padding:2em;
  background-color:#FFF;color:#433;
  font-family:serif; font-size:1em;
}
h1 {
  padding:0.3em 1em; margin:0 -1em;
}
h1 span {
  display:inline-block;
  height:1em;
  border-bottom:dotted 1px #EDF;
}
</style>
</head>
<body>
<div>
  <a href="/">homepage</a>
  <h1><span>KHTDR - Simple Live-Reload Node.js Server</span></h1>
  <p>
  Edit, save, ctrl+tab, refresh. Ctrl+tab back to editor.
  <span style="opacity:0.75">Edit, save, ctrl+tab, refresh. Ctrl+tab back to editor.</span>
  <span style="opacity:0.5">Edit, save, ctrl+tab, refresh. Ctrl+tab back to editor.</span>
  <span style="opacity:0.25">Edit, save, ctrl+tab, refresh. Ctrl+tab back to editor.</span>

  <p>You know the drill, and you want a better way!

  <h2>The Setup</h2>

  <p>
  You are editing HTML, CSS, and Javascript by hand, because you like it.
  You've had some of that hot-reloading goodness before, and you want it now,
  too.
  
  <p>
  You don't feel like spending the weekend reading Webpack docs, so you decide
  that it should only take a few dozen lines of Javascript, at most, to roll
  your own.

  <p>
  You already have node and npm installed. So you go for it.

  <h2>Planning a solution</h2>

  You want to be able to:
  <ul>
    <li>serve static files
    <li>refresh the page whenever a file changes
  </ul>

  <p>
  For serving static files, there are many options to choose. The best choice
  will be the one that allows you to solve the "refresh" problem easiest.

  <p>
  How can you <strong>refresh the page when a file changes</strong>?
  Since you want paths to work as expected, so you can include css, images,
  and javascript, etc., you will run an HTTP server.

  <p>
  You will need to:
  <ol>
    <li>detect when a file changes
    <li>send a signal from the server to the web browser
    <li>trigger a reresh on the page
  </ol>


  <p>Simple enough :)

  <h2>Building the solution</h2>

  <h3>Putting together a web server</h3>
  <p>
  <a href="http://expressjs.com/">Express.js</a> has a built-in solution for
      serving static files. And Node.js already has the http server.

  <pre><code>
  cd ~/live-reload-app # ya know, or whever you want
  npm install express
  </code></pre>

  <p>This HTTP server listens on port 8080 and serves files found in the same
      directory.

  <pre><code>
  var express = require('express');
  var app = express();
  app.use(express.static(__dirname));

  var http = require('http').Server(app);
  http.listen(8080);
  </code></pre>

  <p>
  Save the code above to a file named <code>server.js</code> and run it:

  <pre><code>
  node server.js
  </code></pre>

  <p>
  You can verify it is working by opening a browser and going to
  <code>http://localhost:8080/server.js</code>. You will see your code that is
  running. Take some time now to create a minimal webpage with an external
  stylesheet.

  <p>Create the HTML. Save it to <code>index.html</code>

  <pre><code>
  &lt;!doctype html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;link rel='stylesheet' href='/css/theme.css' /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    Greetings!
  &lt;/body&gt;
  &lt;/body&gt;
  </code></pre>

  <p>and the CSS

  <pre><code>
  mkdir ./css/
  echo "body { background-color:yellow }" &gt; ./css/theme.css
  </code></pre>

  Make sure the server is running, and go to
  <code>http://localhost:8080</code>. You will see a yellow page with your
  greeting.

  <h3>Implementing the "live-reload" feature</h3>

  Node.js provides a file-watcher you can use to monitor the directory for
  changes. But the docs also have something to say about using this feature.

  <blockquote>
    The fs.watch API is not 100% consistent across platforms, and is unavailable in some situations.
    <br /><br />

    The recursive option is only supported on OS X and Windows.
  </blockquote>

  <p>
  Lucky(?) for you, this is good enough to get started. You will still need to
  signal to the browser when a change is detected, and for that you can use
  <a href="http://socket.io/">Socket.io</a>.

  <pre><code>
  npm install socket.io
  </code></pre>

  <p>
  The code is straight forward. Watch the working directory for changes, and
  emit an event with Socket.io.

  <pre><code>
  var fs = require('fs');
  var io = require('socket.io')(http);
  fs.watch(__dirname, { recursive:true }, function () {
    io.emit('file-change-event');
  });
  </code></pre>

  <p>
  The Socket.io server can be started various ways. Here it is given the HTTP
  server from the previous step.

  <p>
  Finally, a puzzle to solve. Something needs to listen for the
  <code>file-change-event</code> emitted by the server. Upon receiving the
  event, the page also needs refreshed. So it makes sense to put the "listening
  code" on the webpage itself.

  <p>
  For obviously obvious reasons, you don't want to add the javascript to
  <em>every page you fiddle with</em>. Better to have the server inject it
  automatically for you!

  <p>
  So what is this "listening code" that needs to be on every HTML page?

  <pre><code>
    &lt;script src="/node_modules/socket.io-client/socket.io.js"&gt;&lt;/script&gt;
    &lt;script&gt;
      var socket = io();
      socket.on("file-change-event", function () {
        window.location.reload();
      });
    &lt;/script&gt;
  </code></pre>

  <p>
  The snippet above includes the client library that we installed with NPM
  earlier. It creates a new Socket.io client, and upon receiving the
  <code>file-change-event</code> from the server, reloads the page.

  <p>
  Write a <code>GET</code> handler that intercepts requests for HTML pages and
  appends the "listening code" to the page.

  <pre><code>
    app.get('/index.html', function (_, res) {
      fs.readFile(__dirname + '/index.html', function (_, data) {
        res.send(data
        + '&lt;script src="/node_modules/socket.io-client/socket.io.js"&gt;&lt;/script&gt;'
        + '&lt;script&gt;'
        + '  var socket = io();'
        + '  socket.on("file-change-event", function () {'
        + '    window.location.reload();'
        + '  });'
        + '&lt;/script&gt;'
        );
      });
    });
  </code></pre>

  <p>
  The code above must be place <em>before</em> the code that serves the static
  files. If it is placed after, it will have been too late.

  <p>
  The code above only works on the <code>index.html</code> page. That's not
  going to cut it, since you could have just put the code into that page itself
  and skipped this part. The code needs modified to answer for all HTML pages,
  even the unnamed default ones (index.html).

  <p>
  Change the first few lines above from:

  <pre><code>
    app.get('/index.html', function (_, res) {
      fs.readFile(__dirname + '/index.html', function (_, data) {
        ...
      });
    });
  </code></pre>

  <p>to:

  <pre><code>
    app.get([/\/$/, /.*\.html$/], function (req, res) {
      var filename = __dirname + req.path;
      filename += filename.endsWith('/')? 'index.html': '';
      fs.readFile(filename, function (_, data) {
        ...
      });
    });
  </code></pre>

  <p>
  Now if the request ends with <code>/</code>, you append
  <code>index.html</code> to the name.

  <p>
  Now, <strong>put it all together!</strong>

  <pre><code>
  var express = require('express');
  var app = express();
  app.get([/\/$/, /.*\.html$/], function (req, res) {
    var filename = __dirname + req.path;
    filename += filename.endsWith('/')? 'index.html': '';
    fs.readFile(filename, function (_, data) {
      res.send(data
      + '&lt;script src="/node_modules/socket.io-client/socket.io.js"&gt;&lt;/script&gt;'
      + '&lt;script&gt;'
      + '  var socket = io();'
      + '  socket.on("file-change-event", function () {'
      + '    window.location.reload();'
      + '  });'
      + '&lt;/script&gt;'
      );
    });
  });
  app.use(express.static(__dirname));

  var http = require('http').Server(app);
  http.listen(8080);

  var fs = require('fs');
  var io = require('socket.io')(http);
  fs.watch(__dirname, { recursive:true }, function () {
    io.emit('file-change-event');
  });
  </pre></code>

  <p><strong>That's it!</strong>

  <p>
  Start the server with <code>node server.js</code>, go to
  <code>http://localhost:8080</code> in your browser, and take a good look at
  your yellow page. Open up the css file you created earlier, and change
  <code>yellow</code> to <code>orange</code>. Save, <em>but don't refresh your
    page</em>. Just observe. The page will automatically update.

  <p>That's it? What next?
  <ul>
    <li>Make more pages
    <li>???
    <li>Profit
  </ul>

  <p>
  I don't know, you tell me :)


  <p><small>
    Where are the comments? There are no comments. Better yet, email me with
    your suggestions, corrections, additions, questions, whatever. If it adds
    to the discussion, I will happily include it here with a link to your work.
  </small>


  <p> <a href="/">homepage</a>
</div>
</body>
</html>
